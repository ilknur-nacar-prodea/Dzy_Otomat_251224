sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","../model/formatter","sap/ui/core/UIComponent","sap/ui/core/BusyIndicator","sap/m/MessageToast"],function(e,t,r,s,i,l,a,n,o){"use strict";var u=false;var p;var g={Matnr:"",Maktx:"",SipMktr:"",SipBrm:"",ArcStkMktr:"",ArcStkBrm:""};var d,M;var h;return e.extend("app.DzyOtomat.controller.StockReq",{formatter:l,onInit:function(){var e=new t;this.getView().setModel(e,"malzemeListModel");this.getView().getModel("malzemeListModel").setProperty("/malzemeList",[]);var r=a.getRouterFor(this);r.getRoute("StockReq").attachMatched(this._onObjectMatchedDetail,this)},_onObjectMatchedDetail:function(e){this.getView().getModel("malzemeListModel").setProperty("/malzemeList",[]);this.getView().byId("tumuruneklebtn").setEnabled(true);var t=e.getParameter("arguments");d=t.trip;M=t.plate},urunEklePress:function(e){var t=this.getView();if(!this._helpUrunEkle){this._helpUrunEkle=sap.ui.xmlfragment("app.DzyOtomat.view.fragments.depoUrunTalep.UrunEkle",this);t.addDependent(this._helpUrunEkle);this._helpUrunEkle.open()}else{t.addDependent(this._helpUrunEkle);this._helpUrunEkle.open()}},onKapatUrunEkle:function(){this.refreshUrunEkleFrg();this._helpUrunEkle.close()},tumurunEklePress:function(e){var t=this;var r=this.getOwnerComponent().getModel("ARAC");r.read("/DUrnTlpTumMaterialListSet",{success:function(e,r){var s=[];e.results.forEach(function(e){s.push({Matnr:e.Matnr,Maktx:e.Maktx,SipMktr:e.ArcStkMktr,SipBrm:e.ArcStkBrm,ArcStkMktr:e.ArcStkMktr,ArcStkBrm:e.ArcStkBrm})});t.getView().getModel("malzemeListModel").setData({malzemeList:s});t.getView().byId("tumuruneklebtn").setEnabled(false);sap.ui.core.BusyIndicator.hide()},error:function(e){sap.ui.core.BusyIndicator.hide()}})},tumunuSilPress:function(e){this.getView().getModel("malzemeListModel").setData({malzemeList:[]});this.getView().byId("tumuruneklebtn").setEnabled(true)},onUEkleMlzNo:function(e){var t=this.getView();if(!this._helpMlzList){this._helpMlzList=sap.ui.xmlfragment("app.DzyOtomat.view.fragments.depoUrunTalep.MlzList",this);t.addDependent(this._helpMlzList);this._helpMlzList.open()}else{t.addDependent(this._helpMlzList);this._helpMlzList.open()}},CloseMlzList:function(){this._helpMlzList.destroy();this._helpMlzList=undefined;this._helpMlzList.close()},ConfirmMlzEkle:function(e){var t=e.getParameter("selectedContexts");var r=t[0].getProperty("Matnr");sap.ui.getCore().byId("UEkleMlzNo").setValue(r);var s=t[0].getProperty("Maktx");sap.ui.getCore().byId("UEkleMlzAck").setText(s);var i=t[0].getProperty("ArcStkMktrBrm");sap.ui.getCore().byId("UEkleArcStk").setText(i);var l=t[0].getProperty("DepoStkMktrBrm");sap.ui.getCore().byId("UEkleDepoStk").setText(l);var a=t[0].getProperty("DepoStkMktrBrm");a=a.split(" ")[1];sap.ui.getCore().byId("UEkleSipBrm").setText(a);this._helpMlzList.destroy();this._helpMlzList=undefined},searchMlz:function(e){debugger;var t=e.getParameter("value");var r=[new s({filters:[new s("Matnr",i.Contains,t)]})];var l=sap.ui.getCore().byId("MlzListTableId");var a=l.getBinding("items");a.filter(r)},onKaydetUrunEkle:function(e){debugger;var t=this;if(sap.ui.getCore().byId("UEkleSipMik").getValue()===""||sap.ui.getCore().byId("UEkleMlzNo").getValue()===""){sap.m.MessageBox.error("T�m zorunlu alanlar� doldurunuz")}else{g={Matnr:sap.ui.getCore().byId("UEkleMlzNo").getValue(),Maktx:sap.ui.getCore().byId("UEkleMlzAck").getText(),SipMktr:sap.ui.getCore().byId("UEkleSipMik").getValue(),SipBrm:sap.ui.getCore().byId("UEkleSipBrm").getText(),ArcStkMktr:"",ArcStkBrm:""};var r=this.getView().getModel("malzemeListModel").getProperty("/malzemeList");var s=r.filter(function(e,t){return e.Matnr===sap.ui.getCore().byId("UEkleMlzNo").getValue()});if(s.length>=1){o.show(t.getOwnerComponent().getModel("i18n").getResourceBundle().getText("MaterialJustAdded"))}else{r.push(g);this.getView().getModel("malzemeListModel").setProperty("/malzemeList",r);this.getView().byId("tumuruneklebtn").setEnabled(false);this.refreshUrunEkleFrg();this._helpUrunEkle.close()}}},removeFrmTable:function(e){var t=this.getView().getModel("malzemeListModel").getProperty("/malzemeList");var r=e.oSource.oPropagatedProperties.oBindingContexts.malzemeListModel.sPath.slice(13);t.splice(r,1);this.getView().getModel("malzemeListModel").setProperty("/malzemeList",t);if(t.length===0){this.getView().byId("tumuruneklebtn").setEnabled(true)}u=true;this.onPressItem()},onPressItem:function(e){debugger;if(!u){var t=this.getView().getModel("malzemeListModel").getProperty("/malzemeList");var r=e.getSource().oBindingContexts.malzemeListModel.sPath.slice(13);var s=t[r];var i=this;var l=i.getView();var a="";if(!this._helpUrunDuzenle){this._helpUrunDuzenle=sap.ui.xmlfragment("app.DzyOtomat.view.fragments.depoUrunTalep.UrunDuzenle",this);l.addDependent(this._helpUrunDuzenle);this._helpUrunDuzenle.open();sap.ui.getCore().byId("UEkleMlzNoDzn").setText(s.Matnr);sap.ui.getCore().byId("UEkleMlzAckDzn").setText(s.Maktx);if(s.SipMktr.split(".")[1]==="000"){s.SipMktr=s.SipMktr.split(".")[0]}else{a=s.SipMktr.split(".")[1];if(a===undefined){s.SipMktr=s.SipMktr.split(".")[0]}else{s.SipMktr=s.SipMktr.split(".")[0]+","+a}}sap.ui.getCore().byId("UEkleIadeMikDzn").setValue(s.SipMktr);sap.ui.getCore().byId("UEkleIadeBrmDzn").setText(s.SipBrm)}else{l.addDependent(this._helpUrunDuzenle);this._helpUrunDuzenle.open();sap.ui.getCore().byId("UEkleMlzNoDzn").setText(s.Matnr);sap.ui.getCore().byId("UEkleMlzAckDzn").setText(s.Maktx);if(s.SipMktr.split(".")[1]==="000"){s.SipMktr=s.SipMktr.split(".")[0]}else{a=s.SipMktr.split(".")[1];if(a===undefined){s.SipMktr=s.SipMktr.split(".")[0]}else{s.SipMktr=s.SipMktr.split(".")[0]+","+a}}sap.ui.getCore().byId("UEkleIadeMikDzn").setValue(s.SipMktr);sap.ui.getCore().byId("UEkleIadeBrmDzn").setText(s.SipBrm)}}u=false},onKaydetUrunDzn:function(e){var t;if(sap.ui.getCore().byId("UEkleIadeMikDzn").getValue()===""||sap.ui.getCore().byId("UEkleMlzNoDzn").getText()===""){sap.m.MessageBox.error("T�m zorunlu alanlar� doldurunuz")}else{var r=sap.ui.getCore().byId("UEkleMlzNoDzn").getText();var s=this.getView().getModel("malzemeListModel").getProperty("/malzemeList");var i=s.filter(function(e,s){if(e.Matnr===r){t=s}return e.Matnr===r});i[0].SipMktr=sap.ui.getCore().byId("UEkleIadeMikDzn").getValue();s.splice(t,1,i[0]);this.getView().getModel("malzemeListModel").setProperty("/malzemeList",s);this.refreshUrunDuzenleFrg();this._helpUrunDuzenle.close()}},onKapatUrunDzn:function(){this.refreshUrunDuzenleFrg();this._helpUrunDuzenle.close()},refreshUrunDuzenleFrg:function(e){sap.ui.getCore().byId("UEkleMlzNoDzn").setText("");sap.ui.getCore().byId("UEkleMlzAckDzn").setText("");sap.ui.getCore().byId("UEkleIadeMikDzn").setValue("");sap.ui.getCore().byId("UEkleIadeBrmDzn").setText("")},refreshUrunEkleFrg:function(e){sap.ui.getCore().byId("UEkleMlzNo").setValue("");sap.ui.getCore().byId("UEkleMlzAck").setText("");sap.ui.getCore().byId("UEkleArcStk").setText("");sap.ui.getCore().byId("UEkleDepoStk").setText("");sap.ui.getCore().byId("UEkleSipMik").setValue("");sap.ui.getCore().byId("UEkleSipBrm").setText("")},kaydetPress:function(e){debugger;var t=this;var r=this.getView().getModel("malzemeListModel").getProperty("/malzemeList");var s=JSON.stringify(r);var i=this.getView().getModel("ARAC");n.show();i.callFunction("/DUrnTlpKaydetTbl",{method:"GET",urlParameters:{ivtablevalues:s},success:function(e,r){debugger;n.hide();var s=e.results.filter(function(e,t){return e.Type==="S"});if(s.length>=1){t.getView().getModel("malzemeListModel").setProperty("/malzemeList",[])}t.showMessages(e).then(t.showMessages(e))},error:function(e){debugger;sap.m.MessageBox.error(e.responseText);n.hide()}})},showMessages:function(e){debugger;var t=this;var r=[];var s=e.results;for(var i=0;i<s.length;i++){var l=s[i];var a={MessageType:l.Type,Message:l.Message};r.push(a)}p=new sap.ui.model.json.JSONModel;this.getView().setModel(p,"oMsgModel");this.getView().getModel("oMsgModel").setData(r);if(!this.oMessage){this.oMessage=sap.ui.xmlfragment("app.DzyOtomat.view.fragments.depoUrunTalep.Messages",this);this.getView().addDependent(this.oMessage)}this.oMessage.open();this.getOwnerComponent().getModel("oMsgModel").refresh(true)},onMessageClose:function(){this.oMessage.close()},onNavBack:function(){this.getView().getModel("malzemeListModel").setProperty("/malzemeList",[]);this.getView().byId("tumuruneklebtn").setEnabled(true);var e=this.getOwnerComponent().getRouter();e.navTo("Trips",{trip:d,ino:M})},onScanMaterial:function(e){debugger;this.refreshUrunEkleFrg();var t=e.getParameter("text");n.show();var r=this,s=this.getOwnerComponent().getModel();s.read("/MaterialBarcodeSet('"+t+"')",{success:function(e){h=e.Matnr;r.getMaterialDetail(h);n.hide()},error:function(e){o.show(r.getOwnerComponent().getModel("i18n").getResourceBundle().getText("MaterialNotFound"));n.hide()}})},onClearFilter:function(){h=""},getMaterialDetail:function(e){debugger;var t=this,r=this.getOwnerComponent().getModel("ARAC");var s=[];s.push(new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,e));r.read("/DUrnTlpMaterialListSet",{filters:s,success:function(e){if(e.results.length===0){o.show(t.getOwnerComponent().getModel("i18n").getResourceBundle().getText("MaterialNotFound"))}else{var r=e.results[0].Matnr;sap.ui.getCore().byId("UEkleMlzNo").setValue(r);var s=e.results[0].Maktx;sap.ui.getCore().byId("UEkleMlzAck").setText(s);var i=e.results[0].ArcStkMktrBrm;sap.ui.getCore().byId("UEkleArcStk").setText(i);var l=e.results[0].DepoStkMktrBrm;sap.ui.getCore().byId("UEkleDepoStk").setText(l);var a=e.results[0].DepoStkMktrBrm;a=a.split(" ")[1];sap.ui.getCore().byId("UEkleSipBrm").setText(a)}},error:function(e){o.show(t.getOwnerComponent().getModel("i18n").getResourceBundle().getText("MaterialNotFound"));n.hide()}})}})});